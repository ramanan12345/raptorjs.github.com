$rload(function(e){"use strict";e.resources={isResource:function(t){return t instanceof e.require("resources.Resource")}}});
$rload(function(e){"use strict";e.defineClass("resources.Resource",function(e){return{init:function(e,t){this.setSearchPathEntry(e),this.setPath(t)},setPath:function(e){this.path=e},getPath:function(){return this.path},isFileResource:function(){return!1},getName:function(){return this._name==null&&(this._name=this.path.substring(this.path.lastIndexOf("/")+1)),this._name},getSystemPath:function(){throw e.createError(new Error("getSystemPath() Not Implemented"))},readFully:function(){throw e.createError(new Error("Not Implemented"))},toString:function(){return"["+this.getClass().getName()+": path="+this.getPath()+", systemPath="+this.getSystemPath()+"]"},exists:function(){return!0},findChild:function(t){var n=e.resources;return n.findResource(n.joinPaths(this.getPath(),t))},setSearchPathEntry:function(e){this.searchPathEntry=e},getSearchPathEntry:function(){return this.searchPathEntry},getDirPath:function(){if(!this.dirPath){var e=this.getPath(),t=e.match(/[\\\/][^\\\/]+$/);this.dirPath=e.substring(0,t.index)}return this.dirPath},getParent:function(){throw e.createError(new Error("getParent() Not Implemented"+this.getClass().getName()))},resolve:function(t,n){throw e.createError(new Error("resolve() Not Implemented for "+this.getClass().getName()))}}})});
$rload(function(e){"use strict";e.defineClass("resources.MissingResource",{superclass:"resources.Resource"},function(){var e=function(t){e.superclass.constructor.call(this,null,t)};return e.prototype={exists:function(){return!1}},e})});
raptor.define("resources.BrowserResource","resources.Resource",function(){"use strict";var e=function(t,n,r){e.superclass.constructor.call(this,t,n),this.path=n,this.contents=r};return e.prototype={readFully:function(){return this.contents},getSystemPath:function(){return this.path}},e});
$rload(function(e){"use strict";var t=e.logging.logger("resources"),n=e.require("resources.Resource"),r=e.require("resources.MissingResource"),i=e.require("resources.BrowserResource");e.extend(e.resources,{findResource:function(e){if(e instanceof n)return e;var t=$rget("resource",e);return t?new i(null,e,t):new r(e)}})});
$rload(function(e){"use strict";var t={"*":".*?","?":".?"};e.regexp={escape:function(e){return e.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")},simple:function(e){var n=this;return new RegExp("^"+e.replace(/[\*\?]|[^\*\?]*/g,function(e){return t[e]||n.escape(e)})+"$")}}});
$rload(function(e){"use strict";e.objects={extend:e.extend,forEachEntry:e.forEachEntry,keys:e.keys,values:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(e[n]);return t},entries:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push({key:n,value:e[n]});return t},isEmpty:function(e){if(!e)return!0;for(var t in e)if(e.hasOwnProperty(t))return!1;return!0}}});
raptor.define("json.stringify",function(){"use strict";var e=raptor.require("strings"),t=e.unicodeEncode,n=",",r="null",i=Array,s=/([^ -~]|(["'\\]))/g,o={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r","\\":"\\\\"},u=function(e){return e<10?"0"+e:e},a=function(e){return e.getUTCFullYear()+"-"+u(e.getUTCMonth()+1)+"-"+u(e.getUTCDate())+"T"+u(e.getUTCHours())+":"+u(e.getUTCMinutes())+":"+u(e.getUTCSeconds())+"Z"};return{stringify:function(u,f){f||(f={});var l=f.special||s,c=e.createStringBuilder(),h=function(e){c.append(e)},p=f.useSingleQuote===!0,d=p===!0?"'":'"',v=function(e){return d+e.replace(l,function(e){if(e==='"')return p?'"':'\\"';if(e==="'")return p?"\\'":"'";var n=o[e];return n||t(e)})+d},m=function(e){if(e==null){h(r);return}var t=e.constructor,s,o;if(e===!0||e===!1||t===Boolean)h(e.toString());else if(t===i){h("["),o=e.length;for(s=0;s<o;s++)s!==0&&h(n),m(e[s]);h("]")}else if(t===Date)h(a(e));else{var u=typeof e;switch(u){case"string":h(v(e));break;case"number":h(isFinite(e)?e+"":r);break;case"object":h("{");var f=!0,l;for(var c in e)if(e.hasOwnProperty(c)){l=e[c];if(l==null)continue;f===!1?h(n):f=!1,h(v(c)),h(":"),m(l)}h("}");break;default:h(r)}}};return m(u),c.toString()}}});
raptor.define("xml.dom",function(){"use strict";return{createParser:function(e){var t=raptor.require("xml.dom.DomParser");return new t(e)}}});
raptor.defineClass("xml.dom.DomParser",function(e){"use strict";var t=function(e){};return t.prototype={parse:function(e){try{var t=$.parseXML(e);return t}catch(n){throw new Error("Invalid XML")}}},t});
raptor.define("xml.sax",function(){"use strict";return{createParser:function(e){e=e||{};if(e.dom)return this.createParserForDom(e);var t=raptor.find("xml.sax.SaxParser")||raptor.find("xml.sax.SaxParserDom");return new t(e)},createParserForDom:function(e){var t=raptor.require("xml.sax.SaxParserDom");return new t(e)}}});
raptor.defineClass("xml.sax.BaseSaxParser",function(){"use strict";var e=raptor.require("listeners"),t=raptor.arrayFromArguments,n=function(){this.observable=e.createObservable(["startElement","endElement","characters","comment","error"])};return n.prototype={on:function(e,t){this.observable.subscribe.apply(this.observable,arguments)},_startElement:function(e){this.observable.publish("startElement",e)},_endElement:function(e){this.observable.publish("endElement",e)},_characters:function(e){e=e.replace(/\r\n|\r/g,"\n"),this.observable.publish("characters",e)},_comment:function(e){this.observable.publish("comment",e)},_error:function(){var e=t(arguments);this.observable.publish("error",e)},getPos:function(){return"(unknown)"}},n});
raptor.define("xml.dom-to-sax",function(){"use strict";var e=function(e){this.node=e};e.prototype={getNamespaceURI:function(){return this.node.namespaceURI||""},getLocalName:function(){return this.node.localName},getQName:function(){return this.node.prefix?this.node.prefix+":"+this.node.localName:this.node.localName},getValue:function(){return this.node.nodeValue},getPrefix:function(){return this.node.prefix},toString:function(){return"[Attribute: uri="+this.getNamespaceURI()+", qName="+this.getQName()+", value="+this.getValue()+"]"}};var t=function(e){this.node=e};return t.prototype={getNamespaceURI:function(){return this.node.namespaceURI||""},getLocalName:function(){return this.node.localName},getQName:function(){return this.node.prefix?this.node.prefix+":"+this.node.localName:this.node.localName},getPrefix:function(){return this.node.prefix||""},getAttributes:function(){var t=this.attributes;if(!t){t=this.attributes=[];var n=this.node.attributes;for(var r=0,i=n.length;r<i;r++)t.push(new e(n.item(r)))}return t},getNamespaceMappings:function(){var e=this._namespaceMappings;return e||(e=this._namespaceMappings={},raptor.forEach(this.getAttributes(),function(t){t.getPrefix()==="xmlns"&&(e[t.getLocalName()]=t.getValue())},this)),e},toString:function(){var e=[];return raptor.forEach(this.getAttributes(),function(t){e.push(t.toString())},this),e=e.join(", "),"[Element: uri="+this.getNamespaceURI()+", localName="+this.getLocalName()+", qName="+this.getQName()+", prefix="+this.getPrefix()+", attributes=["+e+"], ns="+JSON.stringify(this.getNamespaceMappings())+"]"}},{domToSax:function(e,n,r){var i=raptor.require("listeners").createObservable(["startElement","endElement","comment","characters"],!0);i.subscribe(n,r);var s=function(e){i.characters(e.nodeValue)},o=function(e){i.comment(e.nodeValue)},u=function(e){var n=new t(e);i.startElement(n);var r=e.childNodes,s=r.length;for(var o=0;o<s;o++){var u=r[o];a(u)}i.endElement(n)},a=function(e){switch(e.nodeType){case 1:u(e);break;case 2:break;case 3:s(e);break;case 4:s(e);break;case 5:s(e);break;case 6:s(e);break;case 7:break;case 8:o(e);break;case 9:u(e.documentElement)}};a(e)}}});
raptor.defineClass("xml.sax.SaxParserDom","xml.sax.BaseSaxParser",function(e){"use strict";var t=function(e){t.superclass.constructor.call(this)};return t.prototype={parse:function(t,n){var r;if(t.documentElement)r=t;else{var i=e.require("xml.dom").createParser();r=i.parse(t,n)}e.require("xml.dom-to-sax").domToSax(r.documentElement,{startElement:this._startElement,endElement:this._endElement,comment:this._comment,characters:this._characters},this)}},t});
$rload(function(e){"use strict";e.arrays={forEach:e.forEach,isArray:e.isArray,fromArguments:e.arrayFromArguments,concatArrays:function(e){var t=[],n=0,r=arguments.length,i;for(;n<r;n++)i=arguments[n],i!=null&&(t=t.concat.apply(t,i));return t},pop:function(e){var t=this.peek(e);return e.splice(e.length-1,1),t},peek:function(e){return e&&e.length?e[e.length-1]:undefined}}});
raptor.define("xml.sax.object-mapper",function(e){"use strict";var t=e.forEach,n=e.require("xml.sax"),r=e.forEachEntry,i=e.require("arrays"),s=e.require("strings"),o="string",u="boolean",a="object",f=function(e,t,n){var r=function(e){var r;return t==="attribute"?r=n["@"+e]:t==="element"&&(r=n["<"+e+">"]),r||(r=n[e]),r},i=e.getNamespaceURI(),s;return i?(s=r(i+":"+e.getLocalName()),s||(s=r(i+":*"))):s=r(e.getLocalName()),s||(s=r("*")),typeof s=="function"&&(s=s(e,t)),s},l=function(e,t){var n=[];return r(e,function(e,r){if(s.startsWith(e,"_"))return;if(t&&r._type===a)return;n.push(t?e:e.charAt(0)==="<"?e:"<"+e+">")},this),"["+n.join(", ")+"]"},c=function(e,t){t||(t={}),this.skipping=!1,this.options=t,this.trimText=t.trimText!==!1,this.contextStack=[],this.schema=e};return c.prototype={_parseProp:function(e,t){var n=this.options.parseProp;return n&&(e=n(e,t)),e},_setProperty:function(e,t,n,r,i){typeof r=="string"&&(this.trimText&&(r=s.trim(r)),r=this._parseProp(r,i),t._type===u&&(r=r.toLowerCase(),r=r==="true"||r==="yes"));var o=t._targetProp||(typeof e=="string"?e:e.getNamespaceURI()?e.getNamespaceURI()+":"+e.getLocalName():e.getLocalName());t._set?t._set(n,o,r,i):n[o]=r},skipCurrentElement:function(){if(this.skipping)return;var e=this.getCurrentContext();e.skip=!0,this.skipping=!0},error:function(t){throw e.createError(new Error(t+" ("+this.saxParser.getPos()+")"))},getCurrentContext:function(){return i.peek(this.contextStack)},read:function(t,r){this.saxParser=n.createParser({trim:!0,normalize:!0}),this.contextStack=[],this.skipping=!1;var c=this,h,p=this.saxParser;return p.on({error:function(e){c.error(e)},startElement:function(t){var n=c.getCurrentContext(),r=n?n.schema:c.schema,i,s={el:t,name:t.getQName(),tagName:t.getLocalName(),uri:t.getNamespaceURI(),parentContext:n};c.contextStack.push(s);if(c.skipping)return;s.schema=i=f(t,"element",r),i||(console.error("EL: ",t),console.error("parentSchema: ",r),c.error("Unexpected element: <"+t.getQName()+">. Expected one of: "+l(r)));if(i._type===o||i._type===u)i._begin&&i._begin(n?n.object:null,s);else if(i._type===a){s.object=i._begin?i._begin(n?n.object:null,s)||{}:{};if(!s.object)throw new Error('_begin() for "'+t.getLocalName()+'" did not return an object.')}if(!c.skipping){var h=t.getAttributes();for(var p=0,d=h.length,v;p<d;p++){v=h[p];if(c.skipping)break;var m=f(v,"attribute",i);m||c.error("Unexpected attribute: "+v.getQName()+". Expected one of: "+l(i,!0));var g=e.extend({},s);g.attr=v,g.name=v.getQName(),c._setProperty(v,m,s.object,v.getValue(),g)}}},characters:function(e){if(c.skipping===!0)return;var t=c.getCurrentContext();t.text=t.text?t.text+e:e},endElement:function(){var e=c.getCurrentContext(),t=e.parentContext,n=e.schema;if(c.skipping!==!0)if(n._type===o||n._type===u)c._setProperty(e.el,n,t?t.object:null,e.text,e),n._end&&n._end(e.object,t?t.object:null,e);else if(n._type===a)e.text!=null&&s.trim(e.text)&&(n._text?c._setProperty("text",n._text,e.object,e.text,e):n._setText?n._setText(e.object,c._parseProp(e.text,e)):c.error("Unexpected text: "+e.text)),n._end&&n._end(e.object,t?t.object:null,e),n._targetProp&&c._setProperty(e.el,n,t?t.object:null,e.object);else if(n._type)throw new Error("Invalid type: "+n._type);c.contextStack.length===1&&(h=e.object),i.pop(c.contextStack),e.skip===!0&&(c.skipping=!1)}}),p.parse(t,r),h}},{createReader:function(e,t){return new c(e,t)},read:function(e,t,n,r){return this.createReader(n,r).read(e,t)}}});
raptor.defineClass("templating.compiler.Expression",function(){"use strict";var e=/"(?:[^"]|\\")*"|'(?:[^']|\\')*'|\s+(?:and|or|lt|gt|eq|ne|lt|gt|ge|le)\s+/g,t=raptor.require("strings"),n={and:" && ",or:" || ",eq:" === ",ne:" !== ",lt:" < ",gt:" > ",ge:" >= ",le:" <= "},r=function(r){return r.replace(e,function(e){return n[t.trim(e)]||e})},i=function(e,t){t!==!1&&typeof e=="string"&&(e=r(e)),this.expression=e};return i.prototype={getExpression:function(){return this.expression},toString:function(){return this.expression}},i});
raptor.defineClass("templating.compiler.ExpressionParser",function(e){"use strict";var t=e.require("templating.compiler.Expression"),n=e.require("strings"),r=e.require("json.stringify").stringify,i=e.require("regexp"),s={"${":"}","{%":"%}","{?":"}",$:null},o=function(t){var n=[];return e.forEach(t,function(e){n.push(i.escape("\\\\"+e)),n.push(i.escape("\\"+e)),n.push(i.escape(e))}),n.join("|")},u=o(["{%","${","$","{?"]),a=function(){return new RegExp(u,"g")},f=/^([_a-zA-Z]\w*)/g,l=function(e,t){var n=e.split("\n"),r=0,i;while(r<n.length){i=n[r];if(t-i.length+1<0)break;t-=i.length+1,r++}return{str:i,pos:t}},c=function(e,t,n){var r=l(e,t);t=r.pos,e=r.str;var i=t-n,s=t+n,o;i<0&&(i=0),s>e.length&&(s=e.length);var u="...",a="...",f="\n"+u+e.substring(i,s)+a+"\n";for(o=0;o<u.length;o++)f+=" ";for(o=i;o<s;o++)f+=o===t?"^":" ";for(o=0;o<a.length;o++)f+=" ";return f},h=function(e){var t=/"(?:[^"]|\\")*"|'(?:[^']|\\')*'|\\\\;|\\;|[\{\};]/g,n,i=0,s=[],o=0;while(n=t.exec(e)){if(n[0]==="{"){i++;continue}if(n[0]==="}"){if(i!==0){i--;continue}}else{if(n[0]==="\\\\;"){e=e.substring(0,n.index)+"\\;"+e.substring(t.lastIndex),t.lastIndex=n.index+1;continue}if(n[0]==="\\;"){e=e.substring(0,n.index)+";"+e.substring(t.lastIndex),t.lastIndex=n.index+1;continue}n[0]===";"&&i===0&&(s.push(e.substring(o,n.index)),o=t.lastIndex)}}o<e.length-1&&s.push(e.substring(o));var u=function(e){var t=[];return d.parse(e,{text:function(e){t.push(r(e))},expression:function(e){t.push(e)}}),t.join("+")};if(s.length===2)return"("+s[0]+" ? "+u(s[1])+" : '')";if(s.length===3)return"("+s[0]+" ? "+u(s[1])+" : "+u(s[2])+")";throw new Error('Invalid simple conditional of "'+expressin+'". Simple conditionals should be in the form {?<expression>;<true-template>[;<false-template>]}')},p=e.defineClass(function(){return{init:function(e,t){this.callback=e,this.callbackThisObj=t,this.text=""},_invokeCallback:function(t,n){if(!this.callback[t])throw e.createError(new Error(t+" not allowed: "+n));this.callback[t].call(this.callbackThisObj,n)},_endText:function(){this.text&&(this._invokeCallback("text",this.text),this.text="")},add:function(e,t){e==="text"?this.addText(t):(this._endText(),this._invokeCallback(e,t))},addText:function(e){this.text+=e},addExpression:function(e){this._endText(),e instanceof t||(e=new t(e)),this._invokeCallback("expression",e)},addScriptlet:function(e){this._endText(),this._invokeCallback("scriptlet",e)}}}),d=function(){};return d.parse=function(t,r,i,o){o||(o={});var u=0,l,v,m,g,y,b,w,E,S=o.custom||{},x=function(t){if(r.error){r.error.call(i,t);return}throw e.createError(new Error(t))},T=a(),N=new p(r,i);T.lastIndex=0;e:while(v=T.exec(t)){if(n.startsWith(v[0],"\\\\"))l=v.index+1,E=v[0].substring(2),g=v.index+v[0].length;else{if(n.startsWith(v[0],"\\")){N.addText(t.substring(u,v.index)),N.addText(v[0].substring(1)),u=T.lastIndex;continue}if(!s.hasOwnProperty(v[0]))throw e.createError(new Error("Illegal state. Unexpected start token: "+v[0]));E=v[0],l=v.index}g=T.lastIndex,u!==l&&N.addText(t.substring(u,l));var C=s[E];if(!C){f.lastIndex=0;var k=f.exec(t.substring(g));if(!k){N.addText(v[0]),T.lastIndex=u=g;continue e}var L=k[1];N.addExpression(L),T.lastIndex=u=g+=L.length;continue e}b=E==="{%",w=E==="{?";var A=/"((?:[^"]|\\")*)"|'((?:[^']|\\')*)'|\%\}|[\{\}]/g;A.lastIndex=g;var O=0,M=[];while(m=A.exec(t)){if(m[0]==="{"){O++;continue}if(m[0]==="}"){if(b)continue;if(O!==0){O--;continue}}else{if(m[0]!=="%}"){(m[0].charAt(0)==="'"||m[0].charAt(0)==='"')&&M.push({start:m.index-g,end:m.index+m[0].length-g,value:m[0].slice(1,-1),json:m[0],quote:m[0].charAt(0)});continue}b||x('Ending "'+m[0]+'" token was found but matched with starting "'+E+'" token. Location: '+c(t,m.index,10))}y=t.substring(g,m.index);var _;if(E==="${"){var D=y.indexOf(":"),P;D!=-1&&(P=y.substring(0,D),_=S[P]||d.custom[P],_&&_.call(d,y.substring(D+1),N))}if(!_)if(b)N.addScriptlet(y);else if(w)N.addExpression(h(y));else{if(M.length)for(var H=M.length-1;H>=0;H--){var B=M[H];if(!B.value)continue;var j=!1,F=[];d.parse(B.value,{text:function(e){F.push(B.quote+e+B.quote)},expression:function(e){j=!0,F.push(e)}}),j&&(y=y.substring(0,B.start)+"("+F.join("+")+")"+y.substring(B.end))}N.addExpression(y)}T.lastIndex=A.lastIndex,u=A.lastIndex;continue e}x('Ending "'+s[E]+'" token not found for "'+E+'" token. Location: '+c(t,v.index,10)+"\n")}u!==t.length&&N.addText(t.substring(u,t.length)),N._endText()},d.custom={xml:function(e,n){e=new t(e),e.escapeXml=!1,n.addExpression(e)},entity:function(e,t){t.addText("&"+e+";")},startTag:function(e,t){t.addText("<"+e+">")},endTag:function(e,t){t.addText("</"+e+">")},newline:function(e,t){t.addText("\n")}},d});
raptor.defineClass("templating.compiler.TypeConverter",function(e){"use strict";var t=e.require("templating.compiler.ExpressionParser"),n=e.require("json.stringify").stringify,r=e.require("templating.compiler.Expression"),i=function(){};return i.convert=function(i,s,o){var u=!1,a=[];if(i==null)return i;if(s==="custom"||s==="identifier")return i;if(s==="expression")return new r(i);var f="";if(o){t.parse(i,{text:function(e){f+=e,a.push(n(e))},expression:function(e){a.push(e),u=!0}});if(u)return new r(a.join("+"));i=f}if(s==="string")return o?new r(i?n(i):"null"):i;if(s==="boolean")return i=i.toLowerCase(),i=i==="true"||i==="yes",o?new r(i):i;if(s==="float"||s==="double"||s==="number"||s==="integer")return s==="integer"?i=parseInt(i,10):i=parseFloat(i),o?new r(i):i;throw e.createError(new Error("Unsupported attribute targetType: "+s))},i});
raptor.defineClass("templating.compiler.AttributeSplitter",function(e){"use strict";var t=e.require("listeners"),n=e.require("strings"),r=["text","expression"],i=e.require("templating.compiler.Expression"),s=e.require("templating.compiler.TypeConverter"),o=/"(?:[^"]|\\")*"|'(?:[^']|\\')*'|==|===|[;=]/g,u=function(){};return u.parse=function(t,r,i){i||(i={});var u=0,a=i.ordered===!0,f=i.defaultName,l,c=-1,h=a?[]:{},p=function(t){if(i.errorHandler){i.errorHandler(t);return}throw e.createError(new Error(t))},d=function(e){if(u===e)return;var i,o;if(c!=-1)i=n.trim(t.substring(u,c)),o=t.substring(c+1,e);else if(f){i=f,o=t.substring(u,e);if(!n.trim(o).length)return}else i=t.substring(u,e);i&&(i=n.trim(i));if(!n.trim(i).length&&!n.trim(o).length){c=-1;return}if(r){var l=r[i]||r["*"];l?(o!=null&&(o=s.convert(o,l.type,l.allowExpressions!==!1)),l.name&&(i=l.name)):p('Invalid sub-attribute name of "'+i+'"')}a?h.push({name:i,value:o}):h[i]=o,c=-1};while(l=o.exec(t))l[0]==";"?(d(l.index),u=l.index+1,c=-1):l[0]=="="&&c==-1&&(c=l.index);return d(t.length),h},u});
raptor.defineClass("templating.compiler.TemplateBuilder",function(e){"use strict";var t="  ",n=e.require("json.stringify").stringify,r=e.require("strings"),i=e.require("templating.compiler.Expression"),s=e.forEach,o=function(n,i){this.resource=i,typeof i=="string"?(this.resource=null,this.filePath=this.path=i):e.require("resources").isResource(i)&&(this.filePath=i.getSystemPath(),this.path=i.getPath()),this.compiler=n,this.options=n.options,this.templateName=null,this.curText=null,this.attributes={},this.firstStatement=!0,this.staticVars=[],this.staticVarsLookup={},this.helperFunctionsAdded={},this.vars=[],this.varsLookup={},this.javaScriptCode=r.createStringBuilder(),this.getStaticHelperFunction("empty","e"),this.getStaticHelperFunction("notEmpty","ne"),this._indent=t+t};return o.prototype={getTemplateName:function(){var e=this.options||{};return e.templateName||this.templateName||e.defaultTemplateName},_getHelperFunction:function(e,t,n){var r=t+":"+(n?"static":"context"),i=this.helperFunctionsAdded[r];return i?i:(n?this.addStaticVar(e,"helpers."+t):this.addVar(e,"contextHelpers."+t),this.helperFunctionsAdded[r]=e,e)},getContextHelperFunction:function(e,t){return this._getHelperFunction(e,t,!1)},getStaticHelperFunction:function(e,t){return this._getHelperFunction(e,t,!0)},hasStaticVar:function(e){return this.staticVarsLookup[e]===!0},addStaticVar:function(e,t){this.staticVarsLookup[e]||(this.staticVarsLookup[e]=!0,this.staticVars.push({name:e,expression:t}))},hasVar:function(e){return this.vars[e]===!0},addVar:function(e,t){this.vars[e]=!0,this.vars.push({name:e,expression:t})},_writeVars:function(e,t,n){if(!e.length)return;t.append(n+"var ");var r=[];s(e,function(t,i){r.push((i!==0?n+"    ":"")+t.name+"="+t.expression+(i===e.length-1?";\n":",\n"))}),t.append(r.join(""))},_endText:function(){if(this.hasErrors())return;var e=this.curText;e&&(this.curText=null,this.write(n(e,{useSingleQuote:!0})))},addText:function(e){if(this.hasErrors())return;this.curText===null?this.curText=e:this.curText+=e},_endWrites:function(){var t=this.curWrites;t&&(this.firstStatement||this.javaScriptCode.append("\n"),this.firstStatement=!1,this.curWrites=null,s(t,function(n,r){var s=n[0],o=n[1],u=n[2];r===0?this.javaScriptCode.append(this.indentStr()+"context."+s+"("):(this.incIndent(),this.javaScriptCode.append(this.indentStr()+"."+s+"("));if(typeof o=="string")this.javaScriptCode.append(o);else if(typeof o=="function")o.call(u);else{if(!(o instanceof i))throw console.error("Illegal argsString: ",o),e.createError(new Error("Illegal state"));this.javaScriptCode.append(o.toString())}r<t.length-1?this.javaScriptCode.append(")\n"):this.javaScriptCode.append(");\n"),r!==0&&this.decIndent()},this))},attr:function(e,t){return this.hasErrors()||this.addContextMethodCall("a",n(e)+","+t),this},attrs:function(e){return this.hasErrors()||this.addContextMethodCall("a",e),this},include:function(e,t){return this.hasErrors()||this.addContextMethodCall("i",e+","+t),this},write:function(e,t){return this.hasErrors()||(t&&(t.escapeXml&&(e=this.getStaticHelperFunction("escapeXml","x")+"("+e+")"),t.escapeXmlAttr&&(e=this.getStaticHelperFunction("escapeXmlAttr","xa")+"("+e+")")),this.addContextMethodCall("w",e)),this},addContextMethodCall:function(e,t,n){if(this.hasErrors())return;this._endText(),this.curWrites||(this.curWrites=[]),this.curWrites.push([e,t,n])},incIndent:function(){this.emptyLine=!1,this._endText(),this._endWrites(),this._indent+=t,this.firstStatement=!0},decIndent:function(){this.emptyLine=!1,this._endText(),this._endWrites(),this._indent=this._indent.substring(t.length),this.firstStatement=!1},code:function(e){return this.hasErrors()?this:(this._endText(),this._endWrites(),this.javaScriptCode.append(e),this)},statement:function(e){return this._endText(),this._endWrites(),this.code((this.firstStatement?"":"\n")+this._indent+e+"\n"),this.firstStatement=!1,this},line:function(e){return this.code(this._indent+e+"\n"),this},indentStr:function(e){if(arguments.length===0)return this._indent;var n=this._indent;for(var r=0;r<e;r++)n+=t;return n},indent:function(){if(arguments.length===0)this.code(this._indent);else if(typeof arguments[0]=="number")this.code(this.indentStr(arguments[0]));else if(typeof arguments[0]=="function"){var e=arguments[0],t=arguments[1];this.incIndent(),e.call(t),this.decIndent()}else typeof arguments[0]=="string"&&this.code(this._indent+arguments[0]);return this},getPath:function(){return this.path},getFilePath:function(){return this.filePath},getOutput:function(){if(this.hasErrors())return"";var e=r.createStringBuilder(),i=this.getTemplateName();i||this.addError('Template name not defined in template at path "'+this.getFilePath()+'"');var s=this.params;return s?s=["context"].concat(s):s=["context"],e.append('$rset("rhtml", '),e.append(n(i)),e.append(", "),e.append("function(helpers) {\n"),this._endText(),this._endWrites(),this._writeVars(this.staticVars,e,t),e.append("\n"+t+"return function(data, context) {\n"),this.vars&&this.vars.length&&(this._writeVars(this.vars,e,t+t),e.append("\n")),this._endText(),this._endWrites(),e.append(this.javaScriptCode.toString()),e.append(t+"}\n});"),e.toString()},setTemplateName:function(e){this.templateName=e},makeExpression:function(t){if(t instanceof i)return t;if(typeof t=="string")return new i(t);throw e.createError(new Error("Unsupported expression object: "+t))},isExpression:function(e){return e instanceof i},getAttribute:function(e){return this.attributes[e]},setAttribute:function(e,t){return this.attributes[e]=t,t},hasErrors:function(){return this.compiler.hasErrors()},addError:function(e,t){this.compiler.addError(e,t)},getErrors:function(){return this.compiler.getErrors()},getNodeClass:function(e,t){return this.compiler.getNodeClass(e,t)},INDENT:t},o});
raptor.defineClass("templating.compiler.TemplateCompiler",function(raptor){"use strict";var TemplateBuilder=raptor.require("templating.compiler.TemplateBuilder"),ParseTreeBuilder=raptor.require("templating.compiler.ParseTreeBuilder"),Expression=raptor.require("templating.compiler.Expression"),minifier=raptor.find("js-minifier"),TypeConverter=raptor.require("templating.compiler.TypeConverter"),TemplateCompiler=function(e,t){this.taglibs=e,this.options=t||{},this.errors=[]};return TemplateCompiler.prototype={transformTree:function(e,t){try{this.taglibs.forEachNodeTransformer(e,function(n){e.isTransformerApplied(n)||(e.setTransformerApplied(n),this._transformerApplied=!0,e.compiler=this,n.getInstance().process(e,this,t))},this)}catch(n){throw raptor.createError(new Error('Unable to compile template at path "'+t.filePath+". Error: "+n.message),n)}e.forEachChild(function(n){if(!n.parentNode)throw raptor.createError(new Error("Invalid node found in tree. parentNode property of child node is not set. Node: "+e));this.transformTree(n,t)},this)},compile:function(e,t,n,r){var i=this,s,o,u=function(){var e="Errors in template:\n",t=i.getErrors();for(var n=0,r=t.length;n<r;n++)e+=n+1+") "+(t[n].pos?"["+t[n].pos+"] ":"")+t[n].message+"\n";var s=new Error(e);throw s.errors=i.getErrors(),s},a;raptor.require("resources").isResource(t)?a=t.getSystemPath():typeof t=="string"&&(a=t);try{s=ParseTreeBuilder.parse(e,a,this.taglibs),o=new TemplateBuilder(this,t);do this._transformerApplied=!1,this.transformTree(s,o);while(this._transformerApplied)}catch(f){throw raptor.createError(new Error('An error occurred while trying to compile template at path "'+a+'". Exception: '+f),f)}try{s.generateCode(o)}catch(f){throw raptor.createError(new Error('An error occurred while trying to compile template at path "'+a+'". Exception: '+f),f)}this.hasErrors()&&u();var l=o.getOutput();minifier&&this.options.minify===!0&&(l=minifier.minify(l)),n&&n.call(r,{source:l,templateName:o.getTemplateName()});var c=this.options;return c&&c.nameCallback&&c.nameCallback(o.getTemplateName()),l},compileAndLoad:function(xmlSrc,resource){var compiledSrc=this.compile(xmlSrc,resource,function(e){raptor.require("templating").unload(e.templateName)});try{eval(compiledSrc)}catch(e){var filePath;throw typeof resource=="string"?filePath=resource:raptor.require("resources").isResource(resource)&&(filePath=resource.getSystempath()),this.logger().error("Unable to load compiled template: "+compiledSrc,e),raptor.createError(new Error('Unable to load template at path "'+filePath+'". Exception: '+e.message),e)}},isExpression:function(e){return e instanceof Expression},createTagHandlerNode:function(e,t){var n=raptor.require("templating.taglibs.core.TagHandlerNode"),r=this.taglibs.getTag(e,t),i=new n(r);return i},convertType:function(e,t,n){return TypeConverter.convert(e,t,n)},addError:function(e,t){this.errors.push({message:e,pos:t})},hasErrors:function(){return this.errors.length!==0},getErrors:function(){return this.errors},getNodeClass:function(e,t){var n=this.taglibs.getTag(e,t);if(n&&n.nodeClass)return raptor.require(n.nodeClass);throw raptor.createError(new Error('Node class not found for uri "'+e+'" and localName "'+t+'"'))}},TemplateCompiler});
raptor.defineClass("templating.compiler.Taglib",function(e){"use strict";var t=function(){this.uri=null,this.shortName=null,this.tags={},this.textTransformers=[],this.attributeMap={},this.functions=[],this.patternAttributes=[]};return t.prototype={addAttribute:function(t){if(t.uri)throw e.createError(new Error('"uri" is not allowed for taglib attributes'));t.name?this.attributeMap[t.name]=t:this.patternAttributes.push(t)},getAttribute:function(e){var t=this.attributeMap[e];if(!t)for(var n=0,r=this.patternAttributes.length;n<r;n++){var i=this.patternAttributes[n];i.pattern.test(e)&&(t=i)}return t},addTag:function(e){var t=(e.uri||"")+":"+e.name;e._taglib=this,this.tags[t]=e},addTextTransformer:function(e){this.textTransformers.push(e)},forEachTag:function(t,n){e.forEachEntry(this.tags,function(e,r){t.call(n,r)},this)},addFunction:function(e){this.functions.push(e)}},t.Tag=e.defineClass(function(){var t=function(){this.name=null,this.uri=null,this.handlerClass=null,this.dynamicAttributes=!1,this.attributeMap={},this.transformers=[],this.nestedVariables=[],this.importedVariables=[],this.preserveWhitespace=!1,this._taglib=null};return t.prototype={addAttribute:function(e){var t=e.uri||"";this.attributeMap[t+":"+e.name]=e},getAttribute:function(e,t){return e==null&&(e=""),this.attributeMap[e+":"+t]||this.attributeMap[e+":*"]||this.attributeMap["*:"+t]||this.attributeMap["*:*"]},getTaglibUri:function(){if(!this._taglib)throw e.createError(new Error("Taglib not set for tag. (uri="+this.uri+", name="+this.name+")"));return this._taglib.uri},toString:function(){return"[Tag: <"+this.uri+":"+this.name+">]"},forEachAttribute:function(t,n){e.forEachEntry(this.attributeMap,function(e,r){t.call(n,r)})},addNestedVariable:function(e){this.nestedVariables.push(e)},addImportedVariable:function(e){this.importedVariables.push(e)},addTransformer:function(e){this.transformers.push(e)}},t}),t.Attribute=e.defineClass(function(){var e=function(){this.name=null,this.uri=null,this.type=null,this.required=!1,this.type="string",this.allowExpressions=!0};return e.prototype={getAttribute:function(e,t){return e==null&&(e=""),this.attributeMap?this.attributeMap[e+":"+t]||this.attributeMap[e+":*"]||this.attributeMap["*:"+t]||this.attributeMap["*:*"]:null},toString:function(){return"[Tag: <"+this.uri+":"+this.name+">]"}},e}),t.NestedVariable=e.defineClass(function(){var e=function(){this.name=null};return e.prototype={},e}),t.ImportedVariable=e.defineClass(function(){var e=function(){this.targetProperty=null,this.expression=null};return e.prototype={},e}),t.Transformer=e.defineClass(function(){var t=0,n=function(){this.id=t++,this.tag=null,this.className=null,this.after=null,this.before=null,this.instance=null,this.properties={}};return n.prototype={getInstance:function(){if(!this.className)throw e.createError(new Error("Transformer class not defined for tag transformer (tag="+this.tag+")"));if(!this.instance){var t=e.require(this.className);if(t.process)return t;this.instance=new t,this.instance.id=this.id}return this.instance},toString:function(){return"[Taglib.Transformer: "+this.className+"]"}},n}),t.Function=e.defineClass(function(){var e=function(){this.name=null,this.functionClass=null,this.bindToContext=!1};return e.prototype={},e}),t});
raptor.defineClass("templating.compiler.TaglibCollection",function(e){"use strict";var t=e.forEach,n=e.extend,r=e.strings,i=e.require("templating.compiler.Taglib"),s=e.require("templating.compiler.ElementNode"),o=e.require("templating.compiler.TextNode"),u=i.Tag,a=i.Transformer,f=/^(?:(\*|(?:(?:@?[A-Za-z0-9_\-]+\s*,\s*)*@?[A-Za-z0-9_\-]+))\s+from\s+)?([^ ]*)(?:\s+as\s+([A-Za-z0-9_\-]+))?$/,l=function(e,t,n){if(e[t]!=null)return e[t];var r=t.indexOf("-"),i,s,o;if(r!=-1){i=t.substring(0,r),o=t.substring(r+1),s=n._prefixes[i];if(s)return{uri:s,name:o,prefix:i}}return null},c=function(n,i){this._tagImports={},this._attrImports={},this._prefixes={};var s=r.trim(i).split(/\s*;\s*/);t(s,function(r){if(!r)return;var i=r.match(f),s,o={},u,a;if(!i)throw e.createError(new Error('Invalid import: "'+r+'"'));s=i[1],u=n.resolveURI(i[2]),a=i[3];if(!a){a=n.resolvePrefix(u)||n.resolveShortName(u);if(!a)throw e.createError(new Error('Unable to handle imports from "'+u+'". The taglib does not have a prefix or short name defined.'))}this._prefixes[a]=u,s&&t(s.split(/\s*,\s*/),function(e){o[e]=!0}),n.forEachTag(u,function(e,t){e.uri===u&&(o["*"]||o[e.name])&&(this._tagImports[e.name]={uri:u,name:e.name,prefix:a}),e.forEachAttribute||console.error("TAG w/o forEachAttribute: ",Object.keys(e)),e.forEachAttribute(function(t){e.uri!==u&&(o["*"]||o["@"+t.name])&&(this._attrImports[t.name]={uri:u,name:t.name,prefix:a})},this)},this)},this)};c.prototype={getImportedTag:function(e){return l(this._tagImports,e,this)},getImportedAttribute:function(e){return l(this._attrImports,e,this)}};var h=function(){this.tagTransformersLookup={},this.tags={},this.textTransformers={},this.taglibsByURI={},this.shortNameToUriMapping={},this.uriToShortNameMapping={},this.uriToPrefixMapping={},this.functionsLookup={}};return h.prototype={getAttribute:function(t,n,r,i){var s=this.tags,o=function(e){var t=s[e];return t?t.getAttribute(r,i):null},u=o(t+":"+n)||o(t+":*")||o("*:*");if(u&&u.uri&&u.uri!=="*"){var a=this.taglibsByURI[u.uri];if(!a)throw e.createError(new Error('Taglib with URI "'+u.uri+'" not found for imported attribute with name "'+i+'"'));u=a.getAttribute(i);if(!u)throw e.createError(new Error('Attribute "'+i+'" imported from taglib with URI "'+u.uri+'" not found in taglib.'))}if(!u){var f=this.resolveShortName(r);if(f!==r)return this.getAttribute(t,n,f,i)}return u},forEachTag:function(t,n,r){t=this.resolveURI(t);var i=this.taglibsByURI[t];if(!i)return;e.forEachEntry(i.tags,function(e,t){n.call(r,t,i)})},isTaglib:function(e){return this.taglibsByURI[e]!=null},add:function(n){var r=this.taglibsByURI[n.uri]||n;this.taglibsByURI[n.uri]=r,n.shortName&&(this.taglibsByURI[n.shortName]=n,n.shortName&&(r.shortName=n.shortName,this.shortNameToUriMapping[n.shortName]=n.uri,this.uriToShortNameMapping[n.uri]=n.shortName),n.prefix&&(r.prefix=n.prefix,this.uriToPrefixMapping[n.uri]=n.prefix)),n.forEachTag(function(e,r){var i=e.uri==null?e.uri=n.uri:e.uri,s=e.name,o=i+":"+s;this.tags[o]=e;if(e.transformers){var u=this.tagTransformersLookup[o]||(this.tagTransformersLookup[o]=[]);t(e.transformers,function(e){u.push(e)},this)}},this),t(n.textTransformers,function(e){this.textTransformers[e.className]=e},this),t(n.functions,function(t){if(!t.name)throw e.createError(new Error("Function name not set."));this.functionsLookup[n.uri+":"+t.name]=t,r.shortName&&(this.functionsLookup[n.shortName+":"+t.name]=t)},this)},forEachNodeTransformer:function(e,t,n){e instanceof s?this.forEachTagTransformer(e.uri,e.localName,t,n):e instanceof o&&this.forEachTextTransformer(t,n)},resolveURI:function(e){return e?this.shortNameToUriMapping[e]||e:e},resolveShortName:function(e){return e?this.shortNameToUriMapping[e]?e:this.uriToShortNameMapping[e]:e},resolvePrefix:function(e){return e?(e=this.resolveURI(e),this.uriToPrefixMapping[e]):e},forEachTagTransformer:function(t,n,r,i){t==null&&(t="");var s={},o=[],u={},a={},f=function(t){e.forEach(t,function(e){s[e.className]||(s[e.className]=e,o.push(e),e.before&&(a[e.before]||(a[e.before]=[])).push(e))})};f(this.tagTransformersLookup["*:*"]),f(this.tagTransformersLookup[t+":*"]),f(this.tagTransformersLookup[t+":"+n]);var l=function(t){u[t.className]||(u[t.className]=!0,t.after&&l(s[t.after]),e.forEach(a[t.className],l),r.call(i,t))};o.forEach(function(e){l(e)},this)},forEachTextTransformer:function(t,n){e.forEachEntry(this.textTransformers,function(e,r){var i=t.call(n,r);return i===!1?!1:!0})},getTag:function(e,t){var n=this.tags[e+":"+t];return n||(n=this.tags[e+":*"]),n},getFunction:function(e,t){return this.functionsLookup[e+":"+t]},getImports:function(e){return new c(this,e)}},h});
raptor.define("templating.compiler",function(e){"use strict";var t=e.require("templating.compiler.TaglibCollection"),n=new t,r=e.extend,i=e.require("templating.compiler.ExpressionParser"),s={minify:!1,preserveWhitespace:{pre:!0,textarea:!0},allowSelfClosing:{script:!1,div:!1,textarea:!1,li:!1,b:!1,a:!1,i:!1},startTagOnly:{img:!0,br:!0,input:!0}};return{createCompiler:function(t){this.discoverTaglibs&&this.discoverTaglibs();var i=e.require("templating.compiler.TemplateCompiler");return t?t=r(r({},s),t):t=s,new i(n,t)},compile:function(e,t,n){return this.createCompiler(n).compile(e,t)},compileAndLoad:function(e,t,n){this.createCompiler(n).compileAndLoad(e,t)},loadTaglibXml:function(t,n){var r=e.require("templating.compiler.TaglibXmlLoader"),i=r.load(t,n);return this.addTaglib(i),i},addTaglib:function(e){n.add(e)},clearTaglibs:function(){n=new t},hasTaglib:function(e){return n.isTaglib(e)},registerCustomExpressionHandler:function(e,t){i.custom[e]=t},defaultOptions:s,taglibs:n}}),raptor.global.$rtld=function(e){"use strict";raptor.require("templating.compiler").addTaglib(e)}
raptor.defineClass("templating.compiler.Node",function(e){"use strict";var t=e.forEachEntry,n=e.forEach,r=e.isArray,i=e.require("objects").isEmpty,s=function(e){this.nodeType||(this._isRoot=!1,this.preserveWhitespace=null,this.nodeType=e,this.parentNode=null,this.previousSibling=null,this.nextSibling=null,this.firstChild=null,this.lastChild=null,this.namespaceMappings={},this.prefixMappings={},this.transformersApplied={},this.properties={})};return s.prototype={setRoot:function(e){this._isRoot=e},getPosition:function(){var e=this.pos||this.getProperty("pos")||{toString:function(){return"(unknown position)"}};return e},addError:function(t){if(!this.compiler)throw e.createError(new Error("Template compiler not set for node "+this));var n=this.getPosition();this.compiler.addError(t+" ("+this.toString()+")",n)},setProperty:function(e,t){this.setPropertyNS(null,e,t)},setPropertyNS:function(e,t,n){e||(e="");var r=this.properties[e];r||(r=this.properties[e]={}),r[t]=n},setProperties:function(e){this.setPropertiesNS(null,e)},setPropertiesNS:function(e,n){e||(e=""),t(n,function(t,n){this.setPropertyNS(e,t,n)},this)},getPropertyNamespaces:function(){return e.keys(this.properties)},getProperties:function(e){return this.getPropertiesNS(null)},getPropertiesByNS:function(){return this.properties},getPropertiesNS:function(e){return e||(e=""),this.properties[e]},forEachProperty:function(e,n){t(this.properties,function(r,i){t(i,function(t,i){e.call(n,r,t,i)},this)},this)},getProperty:function(e){return this.getPropertyNS(null,e)},getPropertyNS:function(e,t){e||(e="");var n=this.properties[e];return n?n[t]:undefined},removeProperty:function(e){this.removePropertyNS("",e)},removePropertyNS:function(e,t){e||(e="");var n=this.properties[e];n&&delete n[t],i(n)&&delete this.properties[e]},removePropertiesNS:function(e){delete this.properties[e]},forEachPropertyNS:function(e,n,r){e==null&&(e="");var i=this.properties[e];i&&t(i,function(e,t){n.call(r,e,t)},this)},forEachChild:function(e,t){if(!this.firstChild)return;var n=this.firstChild;while(n)e.call(t,n),n=n.nextSibling},isTransformerApplied:function(e){return this.transformersApplied[e.id]===!0},setTransformerApplied:function(e){this.transformersApplied[e.id]=!0},hasChildren:function(){return this.firstChild!=null},appendChild:function(e){e.parentNode&&e.parentNode.removeChild(e),this.firstChild?(this.lastChild.nextSibling=e,e.previousSibling=this.lastChild,this.lastChild=e):(this.firstChild=this.lastChild=e,e.nextSibling=null,e.previousSibling=null),e.parentNode=this},appendChildren:function(t){if(!t)return;e.forEach(t,function(e){this.appendChild(e)},this)},isRoot:function(){return this._isRoot===!0},removeChild:function(e){return e.parentNode!==this?null:(this.firstChild===e&&this.lastChild===e?this.firstChild=this.lastChild=null:this.firstChild===e?(this.firstChild=this.firstChild.nextSibling,this.firstChild.previousSibling=null):this.lastChild===e?(this.lastChild=this.lastChild.previousSibling,this.lastChild.nextSibling=null):(e.previousSibling.nextSibling=e.nextSibling,e.nextSibling.previousSibling=e.previousSibling),e.parentNode=null,e.previousSibling=null,e.nextSibling=null,e)},removeChildren:function(){while(this.firstChild)this.removeChild(this.firstChild)},replaceChild:function(e,t){return e===t?!1:t?t.parentNode!==this?!1:(this.firstChild===t&&this.lastChild===t?(this.firstChild=e,this.lastChild=e,e.previousSibling=null,e.nextSibling=null):this.firstChild===t?(e.nextSibling=t.nextSibling,t.nextSibling.previousSibling=e,this.firstChild=e):this.lastChild===t?(e.previousSibling=t,t.previousSibling.nextSibling=e,this.lastChild=e):(t.nextSibling.previousSibling=e,t.previousSibling.nextSibling=e,e.nextSibling=t.nextSibling,e.previousSibling=t.previousSibling),e.parentNode=this,t.parentNode=null,t.previousSibling=null,t.nextSibling=null,!0):!1},insertAfter:function(t,n){return t?n&&n.parentNode!==this?!1:r(t)?(e.forEach(t,function(e){this.insertAfter(e,n),n=e},this),!0):t===n?!1:n===this.lastChild?(this.appendChild(t),!0):(t.parentNode&&t.parentNode.removeChild(t),!n||n===this.lastChild?(this.appendChild(t),!0):(n.nextSibling.previousSibling=t,t.nextSibling=n.nextSibling,t.previousSibling=n,n.nextSibling=t,t.parentNode=this,!0)):!1},insertBefore:function(e,t){if(!e)return!1;if(t&&t.parentNode!==this)return!1;if(r(e)){var n=e,i;for(i=n.length-1;i>=0;i--)this.insertBefore(n[i],t),t=n[i];return!0}return e===t?!1:(e.parentNode&&e.parentNode.removeChild(e),t?this.firstChild===t?(this.firstChild=e,this.firstChild.nextSibling=t,this.firstChild.previousSibling=null,t.previousSibling=this.firstChild,e.parentNode=this):this.insertAfter(e,t.previousSibling):this.appendChild(e),!0)},isTextNode:function(){return!1},isElementNode:function(){return!1},setStripExpression:function(e){this.stripExpression=e},generateCode:function(t){this.compiler=t.compiler;var n=this.isPreserveWhitespace();n==null&&(n=t.options.preserveWhitespace,n===!0||n&&n["*"]?this.setPreserveWhitespace(!0):this.setPreserveWhitespace(!1));try{if(!this.stripExpression||this.stripExpression.toString()==="false")this.doGenerateCode(t);else if(this.stripExpression.toString()==="true")this.generateCodeForChildren(t);else{if(!this.generateBeforeCode||!this.generateAfterCode){this.addError("The c:strip directive is not supported for node "+this),this.generateCodeForChildren(t);return}var r=t.getAttribute("nextStripVarId");r==null&&(r=t.setAttribute("nextStripVarId",0));var i="__strip"+r++;t.statement("var "+i+" = !("+this.stripExpression+");"),t.statement("if ("+i+") {").indent(function(){this.generateBeforeCode(t)},this).line("}"),this.generateCodeForChildren(t),t.statement("if ("+i+") {").indent(function(){this.generateAfterCode(t)},this).line("}")}}catch(s){throw e.createError(new Error("Unable to generate code for node "+this+" at position ["+this.getPosition()+"]. Exception: "+s),s)}},isPreserveWhitespace:function(){return this.preserveWhitespace},setPreserveWhitespace:function(e){this.preserveWhitespace=e},doGenerateCode:function(e){this.generateCodeForChildren(e)},generateCodeForChildren:function(t,n){if(!t)throw e.createError(new Error('The "template" argument is required'));n===!0&&t.incIndent(),this.forEachChild(function(e){e.isPreserveWhitespace()==null&&e.setPreserveWhitespace(this.isPreserveWhitespace()===!0),e.generateCode(t)},this),n===!0&&t.decIndent()},addNamespaceMappings:function(e){if(!e)return;var n=this.namespaceMappings,r=this.prefixMappings;t(e,function(e,t){n[e]=t,r[t]=e})},resolveNamespacePrefix:function(e){var t=this.prefixMappings[e];return!t&&this.parentNode?this.parentNode.resolveNamespacePrefix():t},getNodeClass:function(){return this.nodeClass||this.getClass()},setNodeClass:function(e){this.nodeClass=e},prettyPrintTree:function(){var e=[],t=function(n,r){e.push(r+n.toString()+"\n"),n.forEachChild(function(e){t(e,r+"  ")},this)};return t(this,""),e.join("")}},s});
raptor.defineClass("templating.compiler.ElementNode","templating.compiler.Node",function(){"use strict";var e=raptor.forEachEntry,t=raptor.forEach,n=raptor.require("xml.utils").escapeXmlAttr,r=raptor.require("json.stringify").stringify,i="http://www.w3.org/XML/1998/namespace",s="http://www.w3.org/XML/1998/namespace",o=raptor.require("templating.compiler.ExpressionParser"),u=function(e,t,n){u.superclass.constructor.call(this,"element"),this._elementNode||(this._elementNode=!0,this.prefix=n,this.localName=t,this.uri=e,this.qName=this.localName?(this.prefix?this.prefix+":":"")+this.localName:null,this.dynamicAttributesExpression=null,this.attributes={},this.allowSelfClosing=!0,this.startTagOnly=!1)};return u.prototype={setStartTagOnly:function(e){this.startTagOnly=!0},setAllowSelfClosing:function(e){this.allowSelfClosing=e},isElementNode:function(){return!0},isTextNode:function(){return!1},getAttributes:function(){var t=[];return e(this.attributes,function(e,n){t.push(n)},this),t},getAttribute:function(e){return this.getAttributeNS(null,e)},getAttributeNS:function(e,t){var n=this.attributes[(e||"")+":"+t];return n?n.value:null},setAttribute:function(e,t){this.setAttributeNS(null,e,t)},setAttributeNS:function(e,t,n,r){this.attributes[(e||"")+":"+t]={localName:t,value:n,prefix:r,uri:e,qName:r?r+":"+t:t,name:e?e+":"+t:t,toString:function(){return this.name}}},setEmptyAttribute:function(e){this.setAttribute(e,null)},removeAttribute:function(e){this.removeAttributeNS(null,e)},removeAttributeNS:function(e,t){delete this.attributes[(e||"")+":"+t]},isPreserveWhitespace:function(){var e=u.superclass.isPreserveWhitespace.call(this);if(e===!0)return!0;var t=this.getAttributeNS(i,"space")||this.getAttributeNS(s,"space")||this.getAttribute("xml:space")==="preserve";return t==="preserve"?!0:e},removePreserveSpaceAttr:function(){this.removeAttributeNS(i,"space"),this.removeAttributeNS(s,"space"),this.removeAttribute("space")},setStripExpression:function(e){this.stripExpression=e},doGenerateCode:function(e){this.generateBeforeCode(e),this.generateCodeForChildren(e),this.generateAfterCode(e)},generateBeforeCode:function(r){var i=this.preserveWhitespace=this.isPreserveWhitespace(),s=this.prefix?this.prefix+":"+this.localName:this.localName;i&&this.removePreserveSpaceAttr(),r.addText("<"+s),this.attributes&&e(this.attributes,function(e,i){var u=i.prefix;!u&&i.uri&&(u=this.resolveNamespacePrefix(i.uri)),u?s=u+(i.localName?":"+i.localName:""):s=i.localName;if(i.value===null||i.value===undefined)r.addText(" "+s);else{var a=[],f=!1,l=!0,c=!1;o.parse(i.value,{text:function(e){a.push({text:e}),l=!1},xml:function(e){a.push({xml:e}),l=!1},expression:function(e){f=!0,a.push({expression:e})},error:function(e){c=!0,this.addError('Invalid expression found in attribute "'+s+'". '+e)}},this,{custom:{entity:function(e,t){t.add("xml","&"+e+";")}}}),c?r.addText(s+'="'+n(i.value)+'"'):f&&a.length===1?r.attr(s,a[0].expression):(r.addText(" "+s+'="'),t(a,function(e){if(e.text)r.addText(n(e.text));else if(e.xml)r.addText(e.xml);else{if(!e.expression)throw raptor.createError(new Error("Illegal state"));r.write(e.expression,{escapeXmlAttr:!0})}}),r.addText('"'))}},this),this.dynamicAttributesExpression&&r.attrs(this.dynamicAttributesExpression),this.hasChildren()?r.addText(">"):this.startTagOnly?r.addText(">"):this.allowSelfClosing&&r.addText("/>")},generateAfterCode:function(e){var t=this.prefix?this.prefix+":"+this.localName:this.localName;this.hasChildren()?e.addText("</"+t+">"):!this.startTagOnly&&!this.allowSelfClosing&&e.addText("></"+t+">")},toString:function(){return"<"+(this.prefix?this.prefix+":"+this.localName:this.localName)+">"}},u});
raptor.defineClass("templating.compiler.TextNode","templating.compiler.Node",function(){"use strict";var e=function(t){e.superclass.constructor.call(this,"text"),this.text=t};return e.prototype={doGenerateCode:function(e){var t=this.text;if(t){var n=this.isPreserveWhitespace();n||(this.previousSibling||(t=t.replace(/^\n\s*/g,"")),this.nextSibling||(t=t.replace(/\n\s*$/g,"")),/^\n\s*$/.test(t)&&(t=""),t=t.replace(/\s+/g," ")),e.addText(t)}},getText:function(){return this.text},isTextNode:function(){return!0},isElementNode:function(){return!1},toString:function(){var e=this.text&&this.text.length>25?this.text.substring(0,25)+"...":this.text;return e=e.replace(/[\n]/g,"\\n"),"[text: "+e+"]"}},e});
raptor.defineClass("templating.compiler.ParseTreeBuilder",function(){"use strict";var e=raptor.require("xml.sax"),t=raptor.forEach,n=raptor.require("templating.compiler.TextNode"),r=raptor.require("templating.compiler.ElementNode"),i=function(){};return i.parse=function(e,t,n){var r=new i;return r.parse(e,t,n)},i.prototype={parse:function(i,s,o){var u=this.logger(),a=null,f=null,l=null,c,h=e.createParser({trim:!1,normalize:!1,dom:i.documentElement!=null});return h.on({error:function(e){throw raptor.createError(e)},characters:function(e){if(!a)return;l?l.text+=e:(l=new n(e),l.pos=h.getPos(),a.appendChild(l))},startElement:function(e){l=null;var n,i,s,u=new r;u.prefix=e.getPrefix(),u.localName=e.getLocalName(),u.qName=e.getQName(),u.uri=o.resolveURI(e.getNamespaceURI()),u.addNamespaceMappings(e.getNamespaceMappings()),u.pos=h.getPos(),t(e.getAttributes(),function(e){e.getLocalName()==="imports"&&!e.getNamespaceURI()&&(n=e.getValue())},this),a?a.appendChild(u):(f=u,n&&(c=o.getImports(n))),t(e.getAttributes(),function(e){var t=o.resolveURI(e.getNamespaceURI()),n=e.getLocalName(),r=e.getPrefix();!t&&c&&(i=c.getImportedAttribute(n))&&(t=i.uri,n=i.name,r=i.prefix),u.setAttributeNS(t,n,e.getValue(),r)},this),!u.uri&&c&&(s=c.getImportedTag(u.localName))&&(u.uri=s.uri,u.localName=s.name,u.prefix=s.prefix),a=u},endElement:function(){l=null,a=a.parentNode}},this),h.parse(i,s),f.setRoot(!0),f},getRootNode:function(){return this.rootNode}},i});
raptor.defineClass("templating.compiler.TaglibXmlLoader",function(e){"use strict";var t=e.require("xml.sax.object-mapper"),n=e.require("regexp"),r=e.require("templating.compiler.Taglib"),i=r.Tag,s=r.Attribute,o=r.NestedVariable,u=r.ImportedVariable,a=r.Transformer,f=r.Function,l="string",c="boolean",h="object",p=function(e,t){this.src=e,this.filePath=t};return p.load=function(e,t){var n=new p(e,t);return n.load()},p.prototype={load:function(){var p=this.src,d=this.filePath,v=this.logger(),m={},g=function(t){var n=t["extends"];delete t["extends"];var r=m[n];if(!r)throw e.createError(new Error('Parent tag with ID "'+n+'" not found in taglib at path "'+d+'"'));r["extends"]&&g(r),e.forEachEntry(r,function(e,n){t[e]===undefined&&(t[e]=n)}),t.attributeMap&&r.attributeMap&&t.attributeMap!==r.attributeMap?e.forEachEntry(r.attributeMap,function(e,n){t.attributeMap[e]||(t.attributeMap[e]=n)}):r.attributeMap&&(t.attributemap=r.attributeMap)},y=function(e){if(!e)return;for(var t=0,n=e.length;t<n;t++){var r=e[t];r["extends"]&&g(r)}},b,w={_type:h,_begin:function(){return new s},_end:function(e,t){t.addAttribute(e)},name:{_type:l},pattern:{_type:l,_set:function(e,t,r){var i=n.simple(r);e.pattern=i}},uri:{_type:l},required:{_type:c},type:{_type:l},"allow-expressions":{_type:c,_targetProp:"allowExpressions"}},E={"raptor-taglib":{_type:h,_begin:function(){var e=new r;return b||(b=e),e},attribute:w,"tlib-version":{_type:l,_targetProp:"version"},"short-name":{_type:l,_targetProp:"shortName"},uri:{_type:l},prefix:{_type:l},tag:{_type:h,_begin:function(){return new i},_end:function(e){e.uri===null&&(e.uri=b.uri),b.addTag(e),e.id&&(m[e.id]=e)},name:{_type:l,_targetProp:"name"},uri:{_type:l,_set:function(e,t,n,r){e.uri=n||""}},id:{_type:l},preserveSpace:{_type:c,_targetProp:"preserveWhitespace"},"preserve-space":{_type:c,_targetProp:"preserveWhitespace"},"preserve-whitespace":{_type:c,_targetProp:"preserveWhitespace"},preserveWhitespace:{_type:c,_targetProp:"preserveWhitespace"},"extends":{_type:l,_targetProp:"extends"},"handler-class":{_type:l,_targetProp:"handlerClass"},"node-class":{_type:l,_targetProp:"nodeClass"},"dynamic-attributes":{_type:c,_targetProp:"dynamicAttributes"},attribute:w,"nested-variable":{_type:h,_begin:function(){return new o},_end:function(t,n){if(!t.name)throw e.createError(new Error('The "name" attribute is required for a nested variable'));n.addNestedVariable(t)},name:{_type:l,_targetProp:"name"}},"imported-variable":{_type:h,_begin:function(){return new u},_end:function(t,n){if(!t.targetProperty)throw e.createError(new Error('The "target-property" attribute is required for an imported variable'));if(!t.expression)throw e.createError(new Error('The "expression" attribute is required for an imported variable'));n.addImportedVariable(t)},"target-property":{_type:l,_targetProp:"targetProperty"},expression:{_type:l}},"transformer-class":{_type:l,_set:function(e,t,n){var r=new a;r.className=n,e.addTransformer(r)}},transformer:{_type:h,_begin:function(){return new a},_end:function(e,t){t.addTransformer(e)},"class-name":{_type:l,_targetProp:"className"},after:{_type:l,_targetProp:"after"},before:{_type:l,_targetProp:"before"},"<properties>":{_type:h,_begin:function(e){return e.properties={}},"<*>":{_type:l}}}},"text-transformer":{_type:h,_begin:function(){return new a},_end:function(e){b.addTextTransformer(e)},"class-name":{_type:l,_targetProp:"className"}},"import-taglib":{_type:h,_begin:function(){return{}},_end:function(n){var r=n.path,i=e.require("resources").findResource(r),s;if(!i.exists())throw e.createError(new Error('Imported taglib with path "'+r+'" not found in taglib at path "'+d+'"'));s=i.readFully(),t.read(s,i.getSystemPath(),E)},path:{_type:l}},"function":{_type:h,_begin:function(){return new f},_end:function(e){b.addFunction(e)},name:{_type:l},"class":{_type:l,_targetProp:"functionClass"},"bind-to-context":{_type:c,_targetProp:"bindToContext"}}}};return t.read(p,d,E),y(b.tags),b}},p});
raptor.extend("templating.compiler",function(e,t){"use strict";var n=!1;return{discoverTaglibs:function(){if(n)return;n=!0;var t=$rget("rtld");e.forEach(t,function(t){var n=e.require("resources").findResource(t);n&&n.exists()&&this.loadTaglibXml(n.readFully(),n.getPath())},this)}}});