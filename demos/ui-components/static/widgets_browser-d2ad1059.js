define.extend("raptor/widgets",function(e,t){"use strict";var n=e("raptor/logging").logger("raptor/widgets"),r={},i=e("raptor"),s=i.createError,o=e("raptor/widgets/Widget"),u=function(e){var t={};return i.forEach(e,function(e){t[e[0]]={target:e[1],props:e[2]}},this),t},a=function(e){this.widget=e,this.widgetsById={}};a.prototype={_remove:function(e,t){var n=this.widget,r=this.widgetsById[t];r&&(this.widgetsById[t]=r.filter(function(t){return t!==e})),n[t]===e&&delete n[t]},addWidget:function(e,t){var n=this.widgetsById[t],r=this.widget;n?n.push(e):this.widgetsById[t]=[e];var s=r[t];s?i.isArray(s)?s.push(e):r[t]=[s,e]:r[t]=e},getWidget:function(e){var t=this.widgetsById[e];if(!t||t.length===0)return undefined;if(t.length===1)return t[0];throw s(new Error('getWidget: Multiple widgets found with ID "'+e+'"'))},getWidgets:function(e){return this.widgetsById[e]||[]}};var f=function(i,f,l,c,h,p,d,v){if(!e.exists(i))throw s(new Error('Unable to initialize widget of type "'+i+'". The class for the widget was not found.'));var m,g=e(i);n.debug('Creating widget of type "'+i+'" ('+f+")");if(g.initWidget)c.elId=f,c.events=p,m=g,g.onReady||(g.onReady=t.onReady);else{var y=function(){},b;y.prototype=b=g.prototype,m=new y,o.makeWidget(m,b),m.registerMessages(["beforeDestroy","destroy"],!1);var w=b.events||g.events;w&&m.registerMessages(w,!1),m._id=f,g.getName||(g.getName=function(){return i}),m.constructor||(b.constructor=g),o.legacy&&(m._parentWidget=d),p&&(m._events=u(p)),r[f]=m;if(l&&h){m._assignedId=l,m._scope=h;var E=r[h];if(!E)throw s(new Error("Parent scope not found: "+h));r[h]._doc.addWidget(m,l)}m._doc=new a(m)}return{widget:m,init:function(){var e=function(){try{m.initWidget?m.initWidget(c):g.call(m,c)}catch(e){var t='Unable to initialize widget of type "'+i+"'. Exception: "+e;if(!v)throw e;n.error(t,e)}};m.initBeforeOnDomReady===!0?e():m.onReady(e)}}};return{initWidget:function(e){var t=f(e.type,e.id,e.assignedId,e.config,e.scope?e.scope.id:null,e.events);e.widget=t.widget,e.children.length&&e.children.forEach(this.initWidget,this),t.init()},_serverInit:function(e){var t=function(e,n){if(!e)return;var r=0,i=e.length;for(;r<i;r++){var s=e[r],o=s[0],u=s[1],a=s[2]||{},l=s[3],c=s[4],h=s[5]||{},p=s.slice(6);l===0&&(l=undefined),c===0&&(c=undefined),a===0&&(a=undefined);var d=f(o,u,c,a,l,h,n,1);p&&p.length&&t(p,d.widget),d.init()}};t(e)},get:function(e){return r[e]},_remove:function(e){delete r[e]}}}),$rwidgets=function(){require("raptor/widgets")._serverInit(require("raptor").arrayFromArguments(arguments))},require("raptor/pubsub").subscribe({"dom/beforeRemove":function(e){var t=e.el,n=require("raptor/widgets").get(t.id);n&&n.destroy({removeNode:!1,recursive:!0})},"raptor/component-renderer/renderedToDOM":function(e){var t=require("raptor/widgets"),n=e.context,r=t.getWidgetsContext(n);r.initWidgets()}});